MATCH (p:Passenger)-[:TOOK]->(j:Journey)

WITH p, j, j.food_satisfaction_score AS food_score,

     5 - CASE 
         WHEN round(abs(j.arrival_delay_minutes) / 20.0, 1) > 5 THEN 5.0
         WHEN round(abs(j.arrival_delay_minutes) / 20.0, 1) < 0 THEN 0.0
         ELSE round(abs(j.arrival_delay_minutes) / 20.0, 1)
     END AS delay_score,

     5 - CASE 
         WHEN round(j.number_of_legs * 1.5, 1) > 5 THEN 5.0
         WHEN round(j.number_of_legs * 1.5, 1) < 0 THEN 0.0
         ELSE round(j.number_of_legs * 1.5, 1)
     END AS legs_score,

     5 - CASE 
         WHEN round(j.actual_flown_miles / 3000.0, 1) > 5 THEN 5.0
         WHEN round(j.actual_flown_miles / 3000.0, 1) < 0 THEN 0.0
         ELSE round(j.actual_flown_miles / 3000.0, 1)
     END AS miles_score

WITH p, 
     (0.5 * food_score + 
      0.35 * delay_score + 
      0.1 * legs_score + 
      0.05 * miles_score) AS overall_satisfaction_score

WHERE overall_satisfaction_score > 3

RETURN COUNT(DISTINCT p) AS satisfied_passenger_count